package timescale

import (
	"math"
	"time"
)

// Time scale conversion: UTC → TT → UT1
//
// Skyfield converts UTC → TT (via leap seconds + 32.184s) → UT1 (via ΔT model).
// This file replicates that chain so Go matches Skyfield's time handling exactly.

const (
	SecPerDay = 86400.0
)

// leapSecondTable: UTC Julian Date → TAI-UTC offset in seconds
// Source: IERS Bulletin C (extracted from Skyfield)
var leapSecondTable = [28][2]float64{
	{2441317.5, 10}, // 1972-01-01
	{2441499.5, 11}, // 1972-07-01
	{2441683.5, 12}, // 1973-01-01
	{2442048.5, 13}, // 1974-01-01
	{2442413.5, 14}, // 1975-01-01
	{2442778.5, 15}, // 1976-01-01
	{2443144.5, 16}, // 1977-01-01
	{2443509.5, 17}, // 1978-01-01
	{2443874.5, 18}, // 1979-01-01
	{2444239.5, 19}, // 1980-01-01
	{2444786.5, 20}, // 1981-07-01
	{2445151.5, 21}, // 1982-07-01
	{2445516.5, 22}, // 1983-07-01
	{2446247.5, 23}, // 1985-07-01
	{2447161.5, 24}, // 1988-01-01
	{2447892.5, 25}, // 1990-01-01
	{2448257.5, 26}, // 1991-01-01
	{2448804.5, 27}, // 1992-07-01
	{2449169.5, 28}, // 1993-07-01
	{2449534.5, 29}, // 1994-07-01
	{2450083.5, 30}, // 1996-01-01
	{2450630.5, 31}, // 1997-07-01
	{2451179.5, 32}, // 1999-01-01
	{2453736.5, 33}, // 2006-01-01
	{2454832.5, 34}, // 2009-01-01
	{2456109.5, 35}, // 2012-07-01
	{2457204.5, 36}, // 2015-07-01
	{2457754.5, 37}, // 2017-01-01
}

// deltaTTable: year → ΔT (TT-UT1) in seconds
// Source: Skyfield (IERS data + Morrison-Stephenson-Hohenkerk 2020 model)
// 401 entries at yearly intervals from 1800 to 2200.
var deltaTTable = [401][2]float64{
	{1800, 18.3670},
	{1801, 18.0096},
	{1802, 17.6411},
	{1803, 17.2731},
	{1804, 16.9172},
	{1805, 16.5847},
	{1806, 16.2873},
	{1807, 16.0364},
	{1808, 15.8436},
	{1809, 15.7203},
	{1810, 15.6780},
	{1811, 15.7226},
	{1812, 15.8369},
	{1813, 15.9980},
	{1814, 16.1831},
	{1815, 16.3693},
	{1816, 16.5336},
	{1817, 16.6534},
	{1818, 16.7056},
	{1819, 16.6674},
	{1820, 16.5160},
	{1821, 16.2355},
	{1822, 15.8384},
	{1823, 15.3441},
	{1824, 14.7722},
	{1825, 14.1422},
	{1826, 13.4736},
	{1827, 12.7859},
	{1828, 12.0986},
	{1829, 11.4311},
	{1830, 10.8040},
	{1831, 10.2315},
	{1832, 9.7174},
	{1833, 9.2610},
	{1834, 8.8617},
	{1835, 8.5190},
	{1836, 8.2323},
	{1837, 8.0010},
	{1838, 7.8246},
	{1839, 7.7025},
	{1840, 7.6340},
	{1841, 7.6184},
	{1842, 7.6528},
	{1843, 7.7339},
	{1844, 7.8584},
	{1845, 8.0231},
	{1846, 8.2249},
	{1847, 8.4603},
	{1848, 8.7264},
	{1849, 9.0196},
	{1850, 9.3380},
	{1851, 9.6698},
	{1852, 9.9800},
	{1853, 10.2264},
	{1854, 10.3665},
	{1855, 10.3570},
	{1856, 10.1767},
	{1857, 9.8801},
	{1858, 9.5419},
	{1859, 9.2369},
	{1860, 9.0400},
	{1861, 8.9933},
	{1862, 9.0105},
	{1863, 8.9726},
	{1864, 8.7607},
	{1865, 8.2550},
	{1866, 7.3796},
	{1867, 6.2230},
	{1868, 4.9156},
	{1869, 3.5881},
	{1870, 2.3710},
	{1871, 1.3655},
	{1872, 0.5571},
	{1873, -0.0983},
	{1874, -0.6443},
	{1875, -1.1260},
	{1876, -1.5784},
	{1877, -2.0111},
	{1878, -2.4260},
	{1879, -2.8250},
	{1880, -3.2100},
	{1881, -3.5780},
	{1882, -3.9068},
	{1883, -4.1695},
	{1884, -4.3389},
	{1885, -4.3880},
	{1886, -4.3056},
	{1887, -4.1449},
	{1888, -3.9749},
	{1889, -3.8646},
	{1890, -3.8840},
	{1891, -4.0742},
	{1892, -4.3725},
	{1893, -4.6891},
	{1894, -4.9342},
	{1895, -5.0170},
	{1896, -4.8665},
	{1897, -4.4762},
	{1898, -3.8570},
	{1899, -3.0203},
	{1900, -1.9770},
	{1901, -0.7463},
	{1902, 0.6194},
	{1903, 2.0600},
	{1904, 3.5149},
	{1905, 4.9230},
	{1906, 6.2412},
	{1907, 7.4876},
	{1908, 8.6969},
	{1909, 9.9035},
	{1910, 11.1420},
	{1911, 12.4346},
	{1912, 13.7542},
	{1913, 15.0610},
	{1914, 16.3154},
	{1915, 17.4790},
	{1916, 18.5190},
	{1917, 19.4401},
	{1918, 20.2549},
	{1919, 20.9760},
	{1920, 21.6170},
	{1921, 22.1868},
	{1922, 22.6886},
	{1923, 23.1226},
	{1924, 23.4893},
	{1925, 23.7890},
	{1926, 24.0234},
	{1927, 24.1974},
	{1928, 24.3171},
	{1929, 24.3886},
	{1930, 24.4180},
	{1931, 24.4116},
	{1932, 24.3760},
	{1933, 24.3182},
	{1934, 24.2449},
	{1935, 24.1640},
	{1936, 24.0849},
	{1937, 24.0378},
	{1938, 24.0563},
	{1939, 24.1741},
	{1940, 24.4260},
	{1941, 24.8296},
	{1942, 25.3470},
	{1943, 25.9251},
	{1944, 26.5108},
	{1945, 27.0500},
	{1946, 27.5054},
	{1947, 27.8918},
	{1948, 28.2385},
	{1949, 28.5751},
	{1950, 28.9320},
	{1951, 29.3219},
	{1952, 29.6990},
	{1953, 30.0020},
	{1954, 30.2033},
	{1955, 30.4092},
	{1956, 30.7600},
	{1957, 31.3425},
	{1958, 32.0324},
	{1959, 32.6520},
	{1960, 33.0726},
	{1961, 33.3580},
	{1962, 33.6210},
	{1963, 33.9628},
	{1964, 34.4391},
	{1965, 35.0930},
	{1966, 35.9473},
	{1967, 36.9323},
	{1968, 37.9560},
	{1969, 38.9483},
	{1970, 39.9316},
	{1971, 40.9510},
	{1972, 42.1462},
	{1973, 43.3714},
	{1974, 44.4841},
	{1975, 45.4769},
	{1976, 46.4580},
	{1977, 47.5207},
	{1978, 48.5344},
	{1979, 49.5870},
	{1980, 50.5398},
	{1981, 51.3802},
	{1982, 52.1668},
	{1983, 52.9571},
	{1984, 53.7891},
	{1985, 54.3422},
	{1986, 54.8713},
	{1987, 55.3225},
	{1988, 55.8203},
	{1989, 56.2997},
	{1990, 56.8553},
	{1991, 57.5658},
	{1992, 58.3101},
	{1993, 59.1212},
	{1994, 59.9845},
	{1995, 60.7860},
	{1996, 61.6296},
	{1997, 62.2946},
	{1998, 62.9659},
	{1999, 63.4676},
	{2000, 63.8290},
	{2001, 64.0906},
	{2002, 64.2998},
	{2003, 64.4735},
	{2004, 64.5738},
	{2005, 64.6875},
	{2006, 64.8452},
	{2007, 65.1466},
	{2008, 65.4578},
	{2009, 65.7766},
	{2010, 66.0699},
	{2011, 66.3246},
	{2012, 66.6036},
	{2013, 66.9067},
	{2014, 67.2810},
	{2015, 67.6441},
	{2016, 68.1034},
	{2017, 68.5925},
	{2018, 68.9676},
	{2019, 69.2204},
	{2020, 69.3614},
	{2021, 69.3595},
	{2022, 69.2945},
	{2023, 69.2039},
	{2024, 69.1754},
	{2025, 69.1378},
	{2026, 69.0955},
	{2027, 69.0534},
	{2028, 69.0206},
	{2029, 68.9986},
	{2030, 68.9876},
	{2031, 68.9874},
	{2032, 68.9981},
	{2033, 69.0198},
	{2034, 69.0523},
	{2035, 69.0956},
	{2036, 69.1498},
	{2037, 69.2149},
	{2038, 69.2909},
	{2039, 69.3776},
	{2040, 69.4752},
	{2041, 69.5837},
	{2042, 69.7029},
	{2043, 69.8330},
	{2044, 69.9739},
	{2045, 70.1256},
	{2046, 70.2880},
	{2047, 70.4613},
	{2048, 70.6453},
	{2049, 70.8401},
	{2050, 71.0457},
	{2051, 71.2621},
	{2052, 71.4891},
	{2053, 71.7270},
	{2054, 71.9755},
	{2055, 72.2348},
	{2056, 72.5049},
	{2057, 72.7856},
	{2058, 73.0771},
	{2059, 73.3792},
	{2060, 73.6921},
	{2061, 74.0156},
	{2062, 74.3498},
	{2063, 74.6947},
	{2064, 75.0503},
	{2065, 75.4165},
	{2066, 75.7934},
	{2067, 76.1810},
	{2068, 76.5791},
	{2069, 76.9879},
	{2070, 77.4074},
	{2071, 77.8374},
	{2072, 78.2781},
	{2073, 78.7294},
	{2074, 79.1913},
	{2075, 79.6637},
	{2076, 80.1468},
	{2077, 80.6404},
	{2078, 81.1447},
	{2079, 81.6594},
	{2080, 82.1848},
	{2081, 82.7206},
	{2082, 83.2671},
	{2083, 83.8240},
	{2084, 84.3915},
	{2085, 84.9696},
	{2086, 85.5581},
	{2087, 86.1572},
	{2088, 86.7667},
	{2089, 87.3868},
	{2090, 88.0173},
	{2091, 88.6583},
	{2092, 89.3098},
	{2093, 89.9718},
	{2094, 90.6442},
	{2095, 91.3271},
	{2096, 92.0204},
	{2097, 92.7242},
	{2098, 93.4384},
	{2099, 94.1630},
	{2100, 94.8981},
	{2101, 95.6435},
	{2102, 96.3994},
	{2103, 97.1657},
	{2104, 97.9423},
	{2105, 98.7294},
	{2106, 99.5268},
	{2107, 100.3346},
	{2108, 101.1528},
	{2109, 101.9813},
	{2110, 102.8202},
	{2111, 103.6694},
	{2112, 104.5290},
	{2113, 105.3989},
	{2114, 106.2791},
	{2115, 107.1696},
	{2116, 108.0704},
	{2117, 108.9816},
	{2118, 109.9030},
	{2119, 110.8347},
	{2120, 111.7767},
	{2121, 112.7290},
	{2122, 113.6916},
	{2123, 114.6644},
	{2124, 115.6475},
	{2125, 116.6408},
	{2126, 117.6443},
	{2127, 118.6581},
	{2128, 119.6821},
	{2129, 120.7164},
	{2130, 121.7608},
	{2131, 122.8155},
	{2132, 123.8803},
	{2133, 124.9554},
	{2134, 126.0406},
	{2135, 127.1360},
	{2136, 128.2416},
	{2137, 129.3574},
	{2138, 130.4833},
	{2139, 131.6193},
	{2140, 132.7655},
	{2141, 133.9219},
	{2142, 135.0883},
	{2143, 136.2649},
	{2144, 137.4516},
	{2145, 138.6485},
	{2146, 139.8554},
	{2147, 141.0724},
	{2148, 142.2995},
	{2149, 143.5367},
	{2150, 144.7839},
	{2151, 146.0413},
	{2152, 147.3087},
	{2153, 148.5861},
	{2154, 149.8736},
	{2155, 151.1711},
	{2156, 152.4787},
	{2157, 153.7963},
	{2158, 155.1239},
	{2159, 156.4615},
	{2160, 157.8092},
	{2161, 159.1668},
	{2162, 160.5344},
	{2163, 161.9120},
	{2164, 163.2996},
	{2165, 164.6972},
	{2166, 166.1047},
	{2167, 167.5222},
	{2168, 168.9496},
	{2169, 170.3870},
	{2170, 171.8343},
	{2171, 173.2915},
	{2172, 174.7587},
	{2173, 176.2358},
	{2174, 177.7228},
	{2175, 179.2197},
	{2176, 180.7265},
	{2177, 182.2431},
	{2178, 183.7697},
	{2179, 185.3061},
	{2180, 186.8524},
	{2181, 188.4086},
	{2182, 189.9746},
	{2183, 191.5505},
	{2184, 193.1362},
	{2185, 194.7317},
	{2186, 196.3371},
	{2187, 197.9522},
	{2188, 199.5772},
	{2189, 201.2120},
	{2190, 202.8566},
	{2191, 204.5110},
	{2192, 206.1752},
	{2193, 207.8491},
	{2194, 209.5329},
	{2195, 211.2264},
	{2196, 212.9296},
	{2197, 214.6426},
	{2198, 216.3653},
	{2199, 218.0978},
	{2200, 219.8400},
}

// TDBMinusTT returns TDB-TT in seconds for a given TDB (or TT) Julian date.
// Uses the Fairhead & Bretagnon approximation (USNO Circular 179 eq. 2.6).
// The maximum amplitude is about 1.7 milliseconds. Since TDB and TT never
// diverge by more than 2ms, TT can also be passed as the argument.
func TDBMinusTT(jdTDB float64) float64 {
	t := (jdTDB - 2451545.0) / 36525.0
	return 0.001657*math.Sin(628.3076*t+6.2401) +
		0.000022*math.Sin(575.3385*t+4.2970) +
		0.000014*math.Sin(1256.6152*t+6.1969) +
		0.000005*math.Sin(606.9777*t+4.0212) +
		0.000005*math.Sin(52.9691*t+0.4444) +
		0.000002*math.Sin(21.3299*t+5.5431) +
		0.000010*t*math.Sin(628.3076*t+4.2490)
}

// LeapSecondOffset returns TAI-UTC in seconds for a given UTC Julian Date.
// Before 1972 (the leap second era), returns 10.0 (the initial offset).
// After the last entry, returns the most recent offset (37.0 as of 2017).
func LeapSecondOffset(jdUTC float64) float64 {
	n := len(leapSecondTable)
	if jdUTC < leapSecondTable[0][0] {
		return 10.0
	}
	lo, hi := 0, n-1
	for lo < hi {
		mid := (lo + hi + 1) / 2
		if leapSecondTable[mid][0] <= jdUTC {
			lo = mid
		} else {
			hi = mid - 1
		}
	}
	return leapSecondTable[lo][1]
}

// DeltaT returns ΔT = TT-UT1 in seconds for a given year (fractional).
// Uses linear interpolation on the ΔT table.
// Beyond the table range, uses the last/first known value (flat extrapolation).
func DeltaT(year float64) float64 {
	n := len(deltaTTable)
	firstYear := deltaTTable[0][0]
	lastYear := deltaTTable[n-1][0]

	if year <= firstYear {
		return deltaTTable[0][1]
	}
	if year >= lastYear {
		return deltaTTable[n-1][1]
	}

	idx := int(year - firstYear)
	if idx >= n-1 {
		idx = n - 2
	}

	y0 := deltaTTable[idx][0]
	dt0 := deltaTTable[idx][1]
	dt1 := deltaTTable[idx+1][1]

	frac := (year - y0)
	return dt0 + frac*(dt1-dt0)
}

// TimeToJDUTC converts a UTC time.Time to a UTC Julian Date.
func TimeToJDUTC(t time.Time) float64 {
	unixSec := float64(t.Unix()) + float64(t.Nanosecond())/1e9
	return unixSec/SecPerDay + 2440587.5
}

// UTCToTT converts a UTC Julian Date to TT Julian Date.
// TT = UTC + TAI-UTC + 32.184s
func UTCToTT(jdUTC float64) float64 {
	taiOffset := LeapSecondOffset(jdUTC)
	return jdUTC + (taiOffset+32.184)/SecPerDay
}

// TTToUT1 converts a TT Julian Date to UT1 Julian Date using the ΔT table.
// UT1 = TT - ΔT
func TTToUT1(jdTT float64) float64 {
	year := 2000.0 + (jdTT-2451545.0)/365.25
	dt := DeltaT(year)
	return jdTT - dt/SecPerDay
}
