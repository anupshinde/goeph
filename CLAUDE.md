# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

goeph is a Go library for computing planetary positions from JPL SPK ephemeris files, inspired by Python's [Skyfield](https://github.com/skyfielders/python-skyfield) library. All outputs are validated against Skyfield using golden tests. CI runs via GitHub Actions on push/PR to main.

## Build & Test Commands

```bash
make build                        # build all packages
make build-examples               # compile-check all examples
make test                         # run all tests
make test-v                       # run all tests (verbose)
make cover                        # run tests with coverage summary
make cover-html                   # generate HTML coverage report
make vet                          # static analysis
make test-one TEST=TestObserveGolden PKG=./spk/  # run a single test
make clean                        # remove coverage artifacts
```

The project requires Go 1.22+. Single external dependency: `github.com/joshuaferrara/go-satellite`.

## Architecture

The library is organized as independent packages with no circular dependencies:

- **`spk/`** — Core package. Parses JPL SPK/DAF binary ephemeris files (Type 2 and Type 3 segments). Evaluates Chebyshev polynomials via Clenshaw algorithm. Provides `Observe()`/`ObserveFrom()` for light-time corrected positions, `Apparent()`/`ApparentFrom()` for apparent positions (with aberration + deflection), `GeocentricPosition()` for geometric positions, and `EarthVelocity()` for velocity computation. All positions are in km, ICRF frame. Body lookups use a generic segment graph walker that builds chains at `Open()` time. Supports temporal stacking (multiple segments for the same body pair covering different date ranges).
- **`coord/`** — Coordinate transforms: ICRF↔ecliptic, RA/Dec↔ICRF, geodetic↔ICRF, ITRF↔geodetic, ICRF↔galactic, altaz, hour angle/declination, TEME↔ICRF. Includes IAU 2006 precession, IAU 2000A nutation (top 30 terms only), GMST/GAST/ERA sidereal time, WGS84 geodetic conversion, atmospheric refraction (Bennett 1982), stellar aberration (full Lorentz), gravitational light deflection (Sun/Jupiter/Saturn), angular quantities (separation, phase, position angle, elongation, fraction illuminated), frame rotation matrices (Galactic, B1950, Ecliptic, ICRS-to-J2000 bias), generic frame types (`InertialFrame`, `TimeBasedFrame`), and visibility checks (`IsSunlit`, `IsBehindEarth`).
- **`timescale/`** — Time scale chain: UTC→TT (via hardcoded leap second table + 32.184s) → UT1 (via hardcoded delta-T table with cubic spline interpolation, 1800–2200). TDB-TT difference (Fairhead & Bretagnon). Converts `time.Time` to Julian dates.
- **`elements/`** — Osculating Keplerian orbital elements from state vectors. 19-field element set supporting circular, elliptical, parabolic, and hyperbolic orbits.
- **`magnitude/`** — Planetary visual magnitudes using Mallama & Hilton 2018 phase curves (Mercury through Neptune). Includes Saturn ring tilt and Uranus axial tilt geometry.
- **`units/`** — `Angle` type (degrees, hours, radians, arcminutes, arcseconds, DMS, HMS) and `Distance` type (km, AU, meters, light-seconds).
- **`geometry/`** — Line-sphere intersection for shadow/limb computations.
- **`satellite/`** — Wrapper around `go-satellite` for SGP4 propagation, with TEME→ICRF conversion for interoperability with planetary positions.
- **`star/`** — Fixed star coordinates (currently only Galactic Center).
- **`lunarnodes/`** — Mean lunar node ecliptic longitude computation (Meeus formula).
- **`examples/`** — 19 runnable examples covering the full API (see `examples/README.md`).

### Data flow for a typical computation

1. `timescale.TimeToJDUTC()` → `timescale.UTCToTT()` to get TDB Julian date (TDB≈TT)
2. `spk.Open()` loads a `.bsp` file, `spk.Observe(bodyID, tdbJD)` returns light-time corrected ICRF km
3. `coord.ICRFToEcliptic()` or other converters produce final coordinates

For apparent positions: `spk.Apparent(bodyID, tdbJD)` adds stellar aberration and gravitational deflection on top of light-time correction.

### Key design decisions

- Nutation uses only 30 of 687 IAU 2000A terms (~1 arcsecond precision, not micro-arcsecond)
- `bodyWrtSSB()` panics if the requested body is not present in the loaded SPK file
- Leap second and delta-T tables are hardcoded arrays, not loaded from external files

## Testing

Golden test data lives in `testdata/` as JSON files generated by `testdata/generate_golden.py` (requires Python + Skyfield). Golden data covers 3,653 dates at 30-day increments across the full DE440s range (1850–2149). The `.bsp` ephemeris file (`data/de440s.bsp`) and golden JSON files are tracked in git so tests run in CI without any external dependencies.

See `testdata/README.md` for the full tolerance table, sampling strategy, and error source analysis. Keep that file updated when adding or changing golden tests.

Summary of tolerances vs Skyfield:

- SPK positions: <0.01 km (Mercury worst case ~0.002 km)
- Velocity: <0.01 km/day (measured max ~0.0002 km/day)
- Apparent positions: <50 km absolute, <1.5e-5 relative (30-term nutation → ~3 arcsec angular error)
- Altaz: altitude <0.011°, azimuth <0.78°
- UTC→TT: <1e-9 days
- TT→UT1: <1e-6 days (cubic spline)
- GMST: <1e-3°
- Geodetic→ecliptic: <0.035°
- ERA: <1e-8°, TDB-TT: <1e-9 s, Separation: <1e-8°, Elongation: <1e-10°, Refraction: <1e-10°
- Phase angle: <1e-8° (exact vectors), Lunar nodes: <1e-8°
