# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

goeph is a Go library for computing planetary positions from JPL SPK ephemeris files, inspired by Python's [Skyfield](https://github.com/skyfielders/python-skyfield) library. All outputs are validated against Skyfield using golden tests. CI runs via GitHub Actions on push/PR to main.

## Build & Test Commands

```bash
make build                        # build all packages
make test                         # run all tests
make test-v                       # run all tests (verbose)
make cover                        # run tests with coverage summary
make cover-html                   # generate HTML coverage report
make vet                          # static analysis
make test-one TEST=TestObserveGolden PKG=./spk/  # run a single test
make clean                        # remove coverage artifacts
```

The project requires Go 1.22+. Single external dependency: `github.com/joshuaferrara/go-satellite`.

## Architecture

The library is organized as independent packages with no circular dependencies:

- **`spk/`** — Core package. Parses JPL SPK/DAF binary ephemeris files (Type 2 segments only). Evaluates Chebyshev polynomials via Clenshaw algorithm. Provides `Observe()` for light-time corrected geocentric positions and `GeocentricPosition()` for geometric positions. All positions are in km, ICRF frame. Body lookups use a hardcoded `bodyWrtSSB()` switch (not a generic segment graph walker like Skyfield).
- **`coord/`** — Coordinate transforms: ICRF↔ecliptic, RA/Dec↔ICRF, geodetic↔ICRF. Includes IAU 2006 precession, IAU 2000A nutation (top 30 terms only), GMST/GAST sidereal time, and WGS84 geodetic conversion.
- **`timescale/`** — Time scale chain: UTC→TT (via hardcoded leap second table + 32.184s) → UT1 (via hardcoded delta-T table, 1800–2200). Converts `time.Time` to Julian dates.
- **`satellite/`** — Thin wrapper around `go-satellite` for SGP4 propagation.
- **`star/`** — Fixed star coordinates (currently only Galactic Center).
- **`lunarnodes/`** — Mean lunar node ecliptic longitude computation (Meeus formula).

### Data flow for a typical computation

1. `timescale.TimeToJDUTC()` → `timescale.UTCToTT()` to get TDB Julian date (TDB≈TT)
2. `spk.Open()` loads a `.bsp` file, `spk.Observe(bodyID, tdbJD)` returns light-time corrected ICRF km
3. `coord.ICRFToEcliptic()` or other converters produce final coordinates

### Key design decisions

- Nutation uses only 30 of 687 IAU 2000A terms (~1 arcsecond precision, not micro-arcsecond)
- `bodyWrtSSB()` panics on unknown body IDs — only supports bodies listed in `spk/bodies.go`
- Leap second and delta-T tables are hardcoded arrays, not loaded from external files
- No velocity computation, no apparent positions (no aberration/deflection)

## Testing

Golden test data lives in `testdata/` as JSON files generated by `testdata/generate_golden.py` (requires Python + Skyfield). Golden data covers 3,653 dates at 30-day increments across the full DE440s range (1850–2149). The `.bsp` ephemeris file (`data/de440s.bsp`) and golden JSON files are tracked in git so tests run in CI without any external dependencies.

Actual tolerances vs Skyfield (discovered during test development):

- SPK positions: <0.2 km (Mercury worst case due to barycenter chain)
- UTC→TT: <1e-9 days (exact same leap second table)
- TT→UT1: <2e-6 days (linear interpolation vs Skyfield's spline for delta-T)
- GMST: <1e-3° (goeph uses IAU 1982 Meeus formula; Skyfield uses IERS 2000 ERA-based)
- Geodetic→ecliptic: <0.035° (30-term vs 687-term nutation; gap grows with distance from J2000)
- Lunar nodes: <1e-8° (identical Meeus formula)
